# Dépannage exhaustif du bus CH422G / microSD

## Objectif

Diagnostiquer et restaurer la détection de l’extenseur I²C **CH422G** (plage d’adresses 0x20–0x23) sur la Waveshare **ESP32-S3 Touch LCD 7B** afin de récupérer la ligne **CS microSD**, les sorties EXIO (rétroéclairage, GPIO externes) et d’éviter les boucles de redémarrage liées aux échecs de montage SD.

## Vue d’ensemble

```
┌──────────┐       ┌─────────────┐         ┌─────────────┐
│ ESP32-S3 │ SDA=8 │             │ EXIO4 → │  MicroSD CS │
│  GPIO8   │◀──────┤  CH422G     ├────────▶│  (via FFC)  │
│  GPIO9   │ SCL=9 │ (0x20–0x23) │         └─────────────┘
└──────────┘       └─────────────┘
```

L’ESP32-S3 pilote le bus I²C partagé (GT911, capteurs optionnels, CH422G). Lorsque le CH422G ne répond plus, la ligne CS microSD reste flottante, provoquant l’erreur `ESP_ERR_NOT_FOUND` observée dans `idf.py monitor`. Le firmware **SimulRepile** propose un fallback GPIO34, mais celui-ci nécessite un pont physique `EXIO4 → GPIO34`.

## Prérequis matériels et logiciels

| Outil / Logiciel | Utilisation |
|------------------|-------------|
| Multimètre numérique | Vérifier l’alimentation 3V3 et la continuité des nappes. |
| Oscilloscope / analyseur logique (optionnel) | Observer SDA/SCL pour détecter un périphérique bloquant. |
| ESP-IDF ≥ 5.5 | Compilation des firmwares principal et `tools/i2c_scanner`. |
| Documentation Waveshare | [Wiki officiel](https://www.waveshare.com/wiki/ESP32-S3-Touch-LCD-7B). |

## Étapes matérielles détaillées

1. **Alimentation du CH422G**  
   - Localiser le pad `LCD_VDD_FR` (3V3) sur la carte mère.  
   - Mesurer **3,3 V ±5 %** entre `LCD_VDD_FR` et GND lorsque la carte est alimentée.  
   - Si la tension est absente, réinsérer les nappes FFC (LCD et tactile) : un mauvais contact sur `DISP` maintient le CH422G en veille.

2. **État des lignes SDA/SCL**  
   - Mesurer la résistance entre SDA (GPIO8) et 3V3 puis SCL (GPIO9) et 3V3 : elle doit être comprise entre **2,2 kΩ et 4,7 kΩ** (pull-ups présents sur la carte).  
   - À l’oscilloscope, les deux lignes doivent rester au niveau haut lorsqu’aucun périphérique ne communique. Un niveau bas persistant indique un court-circuit ou un périphérique verrouillé.

3. **Continuité des nappes FFC**  
   - Inspecter l’alignement des nappes 40 broches (LCD) et 6 broches (tactile).  
   - Nettoyer les contacts à l’alcool isopropylique si nécessaire, puis réinsérer fermement les nappes en respectant le détrompage sérigraphié.

4. **Pont de secours CS microSD**  
   - Si le CH422G reste muet, souder un fil fin entre le pad `EXIO4` de la carte d’extension (ou du connecteur FFC) et le pad `GPIO34` de l’ESP32-S3.  
   - Laisser `CONFIG_STORAGE_SD_GPIO_FALLBACK_AUTO_MOUNT=n` tant que le pont n’est pas en place afin d’éviter le montage automatique et le watchdog.

> **Astuce** : utiliser du fil émaillé AWG34 et fixer le pont avec un point de colle chaude pour prévenir toute traction accidentelle.

## Paramétrage `menuconfig`

Exécuter `idf.py menuconfig` puis vérifier les sections suivantes :

| Chemin | Valeur recommandée | Impact |
|--------|--------------------|--------|
| `Component config → I2C master bus` | `SDA=8`, `SCL=9`, `Enable internal pull-ups` | Garantit la cohérence avec le câblage Waveshare et renforce les pull-ups externes. |
| `Component config → CH422G expander` | `I2C address 0x20` (plage automatique 0x20–0x23), `EXIO SD-CS=4` | Assure la correspondance avec le routing Waveshare (EXIO4 → microSD-CS). |
| `Component config → Storage / SD card → Allow automatic GPIO CS fallback` | **Activé** | Autorise le firmware à utiliser GPIO34 si CH422G est absent. |
| `Component config → Storage / SD card → Automatically mount the fallback CS` | **Désactivé** tant que le pont EXIO4→GPIO34 n’est pas câblé. | Évite les blocages prolongés lors du montage SD (watchdog). |
| `Component config → Storage / SD card → GPIO number for the SD card CS fallback` | `34` | Correspond à la broche accessible sur la Waveshare 7B. |

Pour bypasser définitivement l’extenseur, activer `CONFIG_STORAGE_SD_USE_GPIO_CS` et définir `CONFIG_STORAGE_SD_GPIO_CS_NUM=34`. Cette option exige un câblage permanent de la CS vers le MCU.

## Analyse des journaux `idf.py monitor`

Les messages suivants valident l’état du système :

- `CH422G ready on 0x20` (ou 0x21–0x23) : l’extenseur répond et la CS repasse par EXIO4.
- `Ligne CS microSD pilotée via CH422G EXIO4.` : confirmation que le fallback n’est plus actif.
- `Bus levels: SDA=1 SCL=1 (0=bas, 1=haut).` : les lignes I²C sont libres.
- `I2C scan (0x08-0x77): …` : instantané automatique des périphériques répondant sur le bus (GT911, sondes). Il doit inclure
  `0x20–0x23` lorsque le CH422G est alimenté.

En cas d’erreur :

| Message | Cause probable | Action |
|---------|----------------|--------|
| `No ACK from CH422G between 0x20 and 0x23` | Absence d’alimentation, SDA/SCL coupés, CH422G HS. | Reprendre la section **Étapes matérielles**. |
| `Attente SD annulée : fallback GPIO34 inactif` | Pont EXIO4→GPIO34 manquant alors que le fallback est engagé. | Câbler le pont, puis activer `Automatically mount the fallback CS`. |
| `CH422G responded on 0x21 instead of configured 0x20` | Strap A0/A1 différent ou module de remplacement. | Mettre `CONFIG_CH422G_I2C_ADDRESS=0x21`. |
| `I2C scan (0x08-0x77): aucun périphérique n'a répondu` | Bus totalement bloqué : nappes débranchées, 3V3 absente, pull-ups arrachés. | Vérifier l’alimentation, relancer `DEV_I2C_Bus_Recover` et contrôler la continuité SDA/SCL. |
| `Le contrôleur tactile GT911 reste visible …` | GT911 (0x5D/0x14) actif mais pas de 0x20–0x23 → panne localisée sur le CH422G ou sa nappe LCD. | Inspecter le pad `LCD_VDD_FR`, la nappe 40 broches et l’extenseur. |

## Validation finale

1. Rebooter la carte et ouvrir `idf.py monitor`.  
2. Vérifier la séquence suivante :
   - `CH422G ready on 0xXX`  
   - `SD card detected and mounted via CH422G-controlled CS`  
   - `microSD prête · CH422G` dans la bannière LVGL (sans symbole d’alerte).  
3. Ouvrir la carte microSD sur un PC : le fichier `/sdcard/selftest.txt` doit contenir `OK <timestamp>`.

## Utilisation de l’utilitaire `tools/i2c_scanner`

Lorsque l’application principale ne monte plus la microSD, flasher l’outil dédié :

```sh
cd tools/i2c_scanner
idf.py set-target esp32s3
idf.py -p <PORT> build flash monitor
```

Le firmware journalise toutes les secondes :

1. `Bus levels: SDA=1 SCL=1` — confirme que les lignes ne sont pas tirées au sol.  
2. `CH422G candidat détecté à 0x20` — le composant répond ; réinstaller le firmware principal.  
3. `Aucun périphérique n'a répondu entre 0x20 et 0x23.` — revenir aux tests matériels (3V3, nappes, pont de secours).

Des instructions supplémentaires (récupération du bus, options `menuconfig`) sont fournies dans [`tools/i2c_scanner/README.md`](../../tools/i2c_scanner/README.md).

## Annexes

- **Tableau de correspondance EXIO → Fonctions**  
  | EXIO | Fonction | Commentaire |
  |------|----------|-------------|
  | 1 | Rétroéclairage LCD | PWM pilotée par l’application. |
  | 2 | GPIO extension 1 | Disponible pour actionneur externe. |
  | 3 | GPIO extension 2 | Disponible pour actionneur externe. |
  | 4 | **CS microSD** | Ligne critique pour le lecteur SD. |
  | 5–8 | Libres / GPIO génériques | Utilisables selon besoins utilisateur. |

- **Références**  
  - [Waveshare ESP32-S3 Touch LCD 7B – Wiki](https://www.waveshare.com/wiki/ESP32-S3-Touch-LCD-7B)  
  - [Fiche technique CH422G](https://www.wch-ic.com/downloads/CH422GDS1_PDF.html)
