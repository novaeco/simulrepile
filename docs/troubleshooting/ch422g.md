# Dépannage du bus CH422G / microSD

## Objectif
Garantir la détection de l'extenseur I²C CH422G (adresse 0x20) sur la Waveshare ESP32-S3 Touch LCD 7B afin de restaurer l'accès au bus I²C partagé (CS microSD, rétroéclairage, GPIO d'extension) et d'éviter les redémarrages en boucle du firmware.

## Prérequis
- Multimètre numérique pour contrôler les alimentations et continuités.
- Oscilloscope ou analyseur logique recommandé pour vérifier l'activité I²C.
- Fiches techniques de la carte Waveshare ([wiki officiel](https://www.waveshare.com/wiki/ESP32-S3-Touch-LCD-7B)).
- ESP-IDF ≥ 5.5 avec le projet **SimulRepile** cloné.

## Étapes matérielles
1. **Alimentation du CH422G**  
   Mesurer 3V3 entre les pads VCC et GND du composant (connecteur `LCD_VDD_FR`). Vérifier que la nappe LCD est bien enfoncée côté carte mère et côté écran.
2. **Lignes SDA/SCL**  
   Confirmer que GPIO8 (SDA) et GPIO9 (SCL) restent tirés au niveau haut (2,2 kΩ – 4,7 kΩ). Les résistances sont montées sur la carte, mais l'option `CONFIG_I2C_MASTER_ENABLE_INTERNAL_PULLUPS` doit rester activée.
3. **FFC LCD et tactile**  
   Une nappe mal engagée coupe `LCD_VDD_FR` ou `DISP`, empêchant le CH422G de sortir de veille. Reposer les nappes en respectant l'alignement sérigraphié.
4. **Recâblage CS de secours**  
   Si l'extenseur est hors service, relier le pad `EXIO4` (CS microSD) au GPIO34 via un fil de test pour exploiter le fallback direct.

## Contrôles logiciels
1. **Configuration ESP-IDF**  
   Lancer `idf.py menuconfig` et vérifier :
   - `Component config → I2C master bus` : `SDA=8`, `SCL=9`, pull-ups internes activés.
   - `Component config → CH422G expander` : adresse `0x20`, ligne EXIO pour la CS (`4` par défaut).
   - `Component config → Storage / SD card` :
     - `Allow automatic GPIO CS fallback` **activé** si le fil EXIO4→GPIO34 est présent.
     - Désactiver cette option si aucun recâblage n'est prévu afin d'éviter une boucle de montage impossible.
2. **Autotest de la CS**  
   `idf.py monitor` doit afficher :
   - `CH422G ready on 0x20` lorsque l'extenseur répond.
   - `Ligne CS microSD pilotée directement par GPIO34.` lorsque le fallback est actif.
3. **Journalisation**  
   Les nouveaux messages `Fallback GPIO34 actif sans câblage détecté` signalent que le firmware abandonne le restart automatique. Suivre les instructions affichées dans le bandeau LVGL.

## Contournements logiciels
- **CS directe temporaire** : garder l'option `Allow automatic GPIO CS fallback` activée et câbler EXIO4→GPIO34 pour continuer d'utiliser la microSD le temps de la réparation.
- **Désactiver le fallback** : mettre `CONFIG_STORAGE_SD_GPIO_FALLBACK=n` (et `CONFIG_STORAGE_SD_USE_GPIO_CS=n`). Le firmware restera sur l'écran d'erreur sans redémarrage tant que CH422G est absent.

## Validation
Après correction :
1. `idf.py -p <PORT> monitor` doit afficher `CH422G ready on 0x20` puis `SD card detected and mounted via CH422G-controlled CS`.
2. Le bandeau LVGL mentionne `microSD prête · CH422G` sans icône d'avertissement.
3. Les fichiers de test `selftest.txt` sont générés sur la carte microSD.

## Références
- [Waveshare ESP32-S3 Touch LCD 7B – Wiki](https://www.waveshare.com/wiki/ESP32-S3-Touch-LCD-7B)
- [Fiche technique CH422G](https://www.wch-ic.com/downloads/CH422GDS1_PDF.html)
