# Dépannage du bus CH422G et de la microSD

## Objectif

Diagnostiquer l’extenseur I²C **CH422G** (0x20–0x27, strap usine 0x24) sur la Waveshare **ESP32-S3 Touch LCD 7B** et sécuriser la liaison microSD désormais câblée directement sur **GPIO34**.

## Architecture matérielle

```
┌──────────┐       ┌─────────────┐         ┌──────────────┐
│ ESP32-S3 │ SDA=8 │             │ EXIO1…8 │  Backlight / │
│  GPIO8   │◀──────┤  CH422G     ├────────▶│  VCOM / CAN  │
│  GPIO9   │ SCL=9 │ (0x20–0x27) │         └──────────────┘
└──────────┘       └─────────────┘         │
                                           │CS (fil direct)
                                           ▼
                                   ┌─────────────┐
                                   │  MicroSD CS │
                                   └─────────────┘
```

La CS microSD n’est plus pilotée par l’extenseur : un fil relie **EXIO4 → GPIO34** afin d’éviter tout accès I²C dans les ISR. Le CH422G reste utilisé pour le rétroéclairage, VCOM, USB_SEL, CAN_SEL, etc.

## Vérifications rapides

1. **Alimentation** : `LCD_VDD_FR` doit fournir 3,3 V ±5 %.
2. **Pull-ups SDA/SCL** : mesurer 2,2–4,7 kΩ vers 3V3.
3. **Nappes FFC** : nettoyer et verrouiller les connecteurs 40 broches (LCD) et 6 broches (tactile).
4. **Pont CS** : assurer la continuité EXIO4 ↔ GPIO34 (fil émaillé conseillé, longueur <5 cm).

## Paramétrage `menuconfig`

| Chemin | Valeur recommandée | Commentaire |
|--------|--------------------|-------------|
| `Component config → I2C master bus` | `SDA=8`, `SCL=9`, pull-ups internes | Cohérent avec le câblage Waveshare. |
| `Component config → CH422G expander` | `I2C address 0x24` | Ajuster si straps A0/A1 modifiés. |
| `Component config → Storage / SD card → Drive SD card CS from an ESP32-S3 GPIO` | **Activé** | Configuration par défaut, indispensable pour éviter les timeouts `0x107`. |
| `Component config → Storage / SD card → GPIO number controlling the SD card CS` | `34` | Adapter en fonction du câblage. |
| `Component config → Storage / SD card → Automatically mount the SD card at boot` | **Activé** | Monte `/sdcard` au démarrage. |

## Journaux attendus (`idf.py monitor`)

- `CH422G prêt @0x24 (SDA=8 SCL=9)` — l’extenseur répond.
- `SD: bus SPI2 MOSI=11 MISO=13 SCLK=12 CS=34`
- `SD: carte montée /sdcard (type=SDHC/SDXC, CSD/CID ok)`

Absence des messages suivants :

- `CH422G transaction fallback to IDF driver`
- `sdmmc_card_init failed (0x107)`
- `Unable to initialize the I2C address`

## En cas d’échec

| Message | Diagnostic | Action |
|---------|------------|--------|
| `No ACK from CH422G between 0x20 and 0x27` | CH422G muet (alimentation / nappes). | Vérifier 3V3, SDA/SCL et relancer `DEV_I2C_Bus_Recover`. |
| `GPIO34 ne répond pas…` | Pont CS rompu. | Ressouder EXIO4→GPIO34 et inspecter la continuité. |
| `GT911 introuvable…` | Contrôleur tactile hors ligne. | Inspecter nappe 6 broches et alimentation 3V3. |
| `SD: montage échoué (… )` | Carte absente ou non FAT32. | Reformater, vérifier la tension pendant le démarrage. |

## Séquence de validation

1. `idf.py fullclean build flash monitor`
2. Vérifier la présence des logs ci-dessus.
3. Sur `/sdcard`, s’assurer que `selftest.txt` contient `OK <timestamp>`.
4. Utiliser `sdmmc_card_print_info()` pour confirmer capacité et type (`SDHC/SDXC`).

## Utilitaires complémentaires

- `tools/i2c_scanner` : permet de cartographier rapidement le bus I²C si le CH422G reste silencieux.
- `docs/README_SD_SPI.md` : détaille le câblage CS→GPIO34 et les arguments de conception.

## Notes

- Le CH422G ne doit plus piloter la CS microSD (I²C interdit en ISR → timeouts `0x107`).
- `CONFIG_SD_USE_FALLBACK_GPIO_CS=y` est fourni dans `sdkconfig.defaults` pour refléter la nouvelle architecture.
- Toute modification du câblage doit être documentée afin de mettre à jour `CONFIG_SD_FALLBACK_CS_GPIO` et les schémas de test.
